From ed33d2311e485d2813eef7445422350ae43a424e Mon Sep 17 00:00:00 2001
From: Julian Winkler <julian.winkler1@web.de>
Date: Thu, 10 Jan 2019 22:13:03 +0100
Subject: [PATCH 1/2] work around problems with null pointer exceptions causing
 segfaults

Change-Id: Icd274168448fe9598b81c8e5d0881c2831e033a3
---
 media/java/android/media/Utils.java               | 15 +++++++++++++++
 .../com/android/server/AlarmManagerService.java   |  4 ++--
 .../java/android/telephony/TelephonyManager.java  |  4 ++--
 3 files changed, 19 insertions(+), 4 deletions(-)

diff --git a/media/java/android/media/Utils.java b/media/java/android/media/Utils.java
index 5b62f16ad31..acf72c8fe69 100644
--- a/media/java/android/media/Utils.java
+++ b/media/java/android/media/Utils.java
@@ -206,6 +206,9 @@ class Utils {
     }
 
     static Size parseSize(Object o, Size fallback) {
+        if(o == null) {
+            return fallback;
+        }
         try {
             return Size.parseSize((String) o);
         } catch (ClassCastException e) {
@@ -234,6 +237,9 @@ class Utils {
     }
 
     static Range<Integer> parseIntRange(Object o, Range<Integer> fallback) {
+        if(o == null) {
+            return fallback;
+        }
         try {
             String s = (String)o;
             int ix = s.indexOf('-');
@@ -255,6 +261,9 @@ class Utils {
     }
 
     static Range<Long> parseLongRange(Object o, Range<Long> fallback) {
+        if(o == null) {
+            return fallback;
+        }
         try {
             String s = (String)o;
             int ix = s.indexOf('-');
@@ -276,6 +285,9 @@ class Utils {
     }
 
     static Range<Rational> parseRationalRange(Object o, Range<Rational> fallback) {
+        if(o == null) {
+            return fallback;
+        }
         try {
             String s = (String)o;
             int ix = s.indexOf('-');
@@ -297,6 +309,9 @@ class Utils {
     }
 
     static Pair<Size, Size> parseSizeRange(Object o) {
+        if(o == null) {
+            return null;
+        }
         try {
             String s = (String)o;
             int ix = s.indexOf('-');
diff --git a/services/core/java/com/android/server/AlarmManagerService.java b/services/core/java/com/android/server/AlarmManagerService.java
index f79a51b13af..3dcf4a007ef 100644
--- a/services/core/java/com/android/server/AlarmManagerService.java
+++ b/services/core/java/com/android/server/AlarmManagerService.java
@@ -3606,7 +3606,7 @@ class AlarmManagerService extends SystemService {
      */
     void setWakelockWorkSource(PendingIntent pi, WorkSource ws, int type, String tag,
             int knownUid, boolean first) {
-        try {
+        /*try {
             final boolean unimportant = pi == mTimeTickSender;
             mWakeLock.setUnimportantForLogging(unimportant);
             if (first || mLastWakeLockUnimportantForLogging) {
@@ -3628,7 +3628,7 @@ class AlarmManagerService extends SystemService {
                 return;
             }
         } catch (Exception e) {
-        }
+        }*/
 
         // Something went wrong; fall back to attributing the lock to the OS
         mWakeLock.setWorkSource(null);
diff --git a/telephony/java/android/telephony/TelephonyManager.java b/telephony/java/android/telephony/TelephonyManager.java
index 37cdb52f7a3..deede8cee7a 100644
--- a/telephony/java/android/telephony/TelephonyManager.java
+++ b/telephony/java/android/telephony/TelephonyManager.java
@@ -3106,7 +3106,7 @@ public class TelephonyManager {
         String number = null;
         try {
             ITelephony telephony = getITelephony();
-            if (telephony != null)
+            if (telephony != null && mContext != null && mContext.getOpPackageName() != null)
                 number = telephony.getLine1NumberForDisplay(subId, mContext.getOpPackageName());
         } catch (RemoteException ex) {
         } catch (NullPointerException ex) {
@@ -3116,7 +3116,7 @@ public class TelephonyManager {
         }
         try {
             IPhoneSubInfo info = getSubscriberInfo();
-            if (info == null)
+            if (info == null || mContext == null || mContext.getOpPackageName() == null)
                 return null;
             return info.getLine1NumberForSubscriber(subId, mContext.getOpPackageName());
         } catch (RemoteException ex) {
-- 
2.20.1

