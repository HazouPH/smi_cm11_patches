From 855045d9494527d9b1538a9df01e5433941bd974 Mon Sep 17 00:00:00 2001
From: Julian Winkler <julian.winkler1@web.de>
Date: Fri, 14 Dec 2018 09:42:57 +0100
Subject: [PATCH 1/2] Revert "Revert "linker: Make platform text relocations
 denial optional""

This reverts commit 081513ebfae5a887055c673950d8163416caa440.
---
 linker/Android.bp | 3 +++
 linker/linker.cpp | 5 +++++
 2 files changed, 8 insertions(+)

diff --git a/linker/Android.bp b/linker/Android.bp
index 50fcf07fd..a039b10a9 100644
--- a/linker/Android.bp
+++ b/linker/Android.bp
@@ -167,6 +167,9 @@ cc_binary {
             cppflags: ["-DUSE_LD_CONFIG_FILE"],
         },
         lineage: {
+            needs_text_relocations: {
+                cppflags: ["-DTARGET_NEEDS_PLATFORM_TEXT_RELOCATIONS"],
+            },
             target_process_sdk_version_override: {
                 cppflags: ["-DSDK_VERSION_OVERRIDES=\"%s\""],
             },
diff --git a/linker/linker.cpp b/linker/linker.cpp
index 951351c32..0427e3f04 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -3621,7 +3621,12 @@ bool soinfo::link_image(const soinfo_list_t& global_group, const soinfo_list_t&
   if (has_text_relocations) {
     // Fail if app is targeting M or above.
     int app_target_api_level = get_application_target_sdk_version();
+#if defined(TARGET_NEEDS_PLATFORM_TEXT_RELOCATIONS)
+    if (app_target_api_level != __ANDROID_API__
+        && app_target_api_level >= __ANDROID_API_M__) {
+#else
     if (app_target_api_level >= __ANDROID_API_M__) {
+#endif
       DL_ERR_AND_LOG("\"%s\" has text relocations (https://android.googlesource.com/platform/"
                      "bionic/+/master/android-changes-for-ndk-developers.md#Text-Relocations-"
                      "Enforced-for-API-level-23)", get_realpath());
-- 
2.20.1

